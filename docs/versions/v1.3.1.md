# v1.3.1

## üöÄ Features

### Connection Resilience
- **SSE Auto-Reconnect**: Automatic reconnection with exponential backoff (1s ‚Üí 2s ‚Üí 4s ‚Üí 8s ‚Üí 16s, max 30s) when SSE connection drops
- **Visibility-Based Refresh**: App data refreshes when returning to tab after 30+ seconds hidden
- **Widget Polling Resilience**: Widgets retry failed API calls 3 times with 1s delay between attempts
- **Auto-Error Recovery**: Widgets automatically clear error state when subsequent polls succeed

### Theming Improvements
- **No More Flash**: Theme loads instantly on page refresh (no more blue flash on light theme)
- **OS Preference Detection**: First-time visitors get theme that matches their system preference
- **Setup Page**: Now fully theme-aware (was hardcoded to dark)
- **Login Page**: Error box now uses proper theme colors

### Dashboard Management Enhancements
- **Re-link Mobile Button**: New button in edit mode to re-link mobile layout to desktop (when in independent mode)
- **Re-link Confirmation Modal**: Professional confirmation modal with clear warning about losing customizations
- **DevDebugOverlay Visibility Info**: Debug overlay now shows per-widget visibility status (üëÅÔ∏è/üëÅÔ∏è‚Äçüó®Ô∏è) and height
- **Smart Change Detection**: Moving a widget and moving it back clears the save button (no false "unsaved changes")
  - Compares current layout vs original when entering edit mode
  - `pendingUnlink` also clears if mobile layout reverted to original
- **Navigation Guard System**: Blocks navigation away from Dashboard when in edit mode with unsaved changes
  - Shows "Unsaved Changes" modal with Cancel/Discard/Save options
  - Shows "Unlink Confirmation" modal (with Discard) when `pendingUnlink` is active
  - Works across all navigation paths: sidebar, mobile tab bar, mobile menu

### Mobile Dashboard Editing (NEW)
- **iOS-Style Hold-to-Drag**: Natural touch gesture for mobile widget editing
  - Hold widget 170ms to unlock for dragging
  - Visual feedback (border glow) indicates drag-ready state
  - Continue holding and drag in one smooth motion
  - Auto-locks after 250ms of inactivity
- **Scroll vs Drag Detection**: Quick swipes scroll the page, holds enable widget dragging
- **Native Touch Event Handling**: Uses `{ passive: false }` listeners to properly block browser scroll during drag
- **Text Selection Prevention**: Global text selection disabled in edit mode for cleaner touch experience

### iOS PWA Improvements (NEW)
- **iOS 26.2 Safe Area Fix**: Resolved black bar in home indicator region on iOS PWA
  - Adopted Seerr-style CSS pattern (padding on html, not position:fixed)
  - Background now properly fills entire viewport including safe areas
- **Safe Area Blur Header**: Glassmorphism blur effect in top notch area when content scrolls behind
  - Only appears when page is scrolled
  - Uses theme-aware glass background
  - Matches Seerr's visual polish

## üêõ Bug Fixes

### Setup Wizard
- **Theme Persistence**: Theme selected during setup now persists after page refresh
- **Theme Settings Sync**: Theme selection now correctly reflected in Settings ‚Üí Customization
- **FlattenUI Persistence**: Flatten UI toggle now persists correctly after setup completion
- **FlattenUI Settings Sync**: Settings toggle now reflects value set during setup
- **Integration Link**: Widget "Integration Settings" link now navigates to correct tab
- **Ripple Animation**: Theme ripple effect now works correctly on rapid theme selections
- **Migration Idempotency**: Database migration v4 now handles existing columns gracefully
- **ES Module Interop**: Fixed `logger.info is not a function` in migrator.js and json-utils.js

### Dashboard (Mobile Layout)
- **Widget Placement**: New widgets now placed at top (y:0) and full width (24 cols lg, 2 cols sm)
- **Pending Unlink Fix**: First widget added to empty dashboard no longer triggers pending unlink
- **Settings State Sync**: Dashboard Management subtab now updates automatically without page refresh
- **Reset Button State**: Reset Dashboard button now disabled when dashboard is empty
- **Plex Widget Visibility**: Plex widget now correctly hides on BOTH desktop AND mobile when no streams
- **Edit Mode Restoration**: Widget heights restore to full size when entering edit mode
- **Debug Overlay Conditional**: Debug overlay/badges only show when enabled in Settings ‚Üí Advanced

## üîß Technical Changes

### NotificationContext.tsx
- Added SSE reconnection with max 5 attempts
- Added visibility change listener to reconnect when tab becomes active
- Reset reconnect attempts on successful connection

### AppDataContext.tsx
- Added visibility change listener to refresh integrations data after idle

### Widget Updates
- PlexWidget: Added retry logic (10s polling)
- SonarrWidget: Added retry logic (60s polling)
- RadarrWidget: Added retry logic (60s polling)
- OverseerrWidget: Added retry logic (60s polling)
- QBittorrentWidget: Added retry logic (5s polling)

### Theming Updates
- `index.html`: Added inline theme detection script before React loads
- `ThemeContext.tsx`: Now syncs theme to localStorage for instant load
- `Setup.tsx`: Replaced hardcoded colors with theme utilities
- `Login.tsx`: Fixed error box colors to use theme variables

### Setup Wizard Fixes
- `SetupWizard.tsx`: Use direct API call + ThemeContext for guaranteed theme persistence
- `SetupWizard.tsx`: Save flattenUI to `preferences.ui.flattenUI` path
- `CustomizationSettings.tsx`: Read theme from `preset` field (not `mode`)
- `CustomizationSettings.tsx`: Read flattenUI from consistent path
- `CustomizeStep.tsx`: Use `flatten-ui` class instead of `data-flatten` attribute
- `IntegrationDisabledMessage.tsx`: Fixed tab link from `widgets` to `integrations`
- `migrator.js` / `json-utils.js`: Fixed ES module default export interop

### Dashboard Updates (This Session)
- `Dashboard.tsx`: Visibility effect now updates BOTH lg and sm layouts simultaneously
- `Dashboard.tsx`: Added edit mode height restoration effect
- `Dashboard.tsx`: Added `widgets-added` and `mobile-layout-mode-changed` event listeners
- `Dashboard.tsx`: Debug overlay and badges conditional on `debugOverlayEnabled` state
- `DashboardManagement.tsx`: Added `widgetCount` state and event listeners for state sync
- `DashboardManagement.tsx`: Reset button disabled when no widgets
- `DevDebugOverlay.tsx`: Added `widgetVisibility` prop with per-widget h/visibility display
- `RelinkConfirmationModal.tsx`: New component for re-link confirmation

### Mobile Touch Gesture System (NEW)
- `useTouchDragDelay.ts`: iOS-style hold-to-drag gesture hook
  - Hold detection with configurable threshold (170ms)
  - Movement detection to distinguish scroll vs hold
  - Auto-reset timer (250ms) after finger lifts
  - Synthetic touch event dispatch for seamless RGL integration
  - Native touchmove listener with `{ passive: false }` for proper scroll blocking
- `Dashboard.tsx`: Integration of touch gesture handlers
- `GridLayout.css`: Visual feedback styles for drag-ready state

### New Files
- `src/utils/useResilientPolling.ts`: Reusable polling hook (available for future use)
- `src/components/dashboard/RelinkConfirmationModal.tsx`: Re-link confirmation modal component
- `src/hooks/useTouchDragDelay.ts`: Mobile touch gesture hook for hold-to-drag
- `src/components/common/SafeAreaBlur.tsx`: iOS safe area blur overlay component
- `src/context/DashboardEditContext.tsx`: Global context for dashboard edit state (navigation blocking)
- `src/hooks/useEditModeAware.ts`: Helper hook for widgets to detect edit mode
- `src/components/dashboard/UnsavedChangesModal.tsx`: Modal for unsaved changes when navigating away

### iOS PWA Updates (This Session)
- `src/index.css`: Adopted Seerr-style safe area pattern (padding on html, removed position:fixed)
- `src/App.tsx`: Added SafeAreaBlur component to MainLayout, added overflow:hidden to main element
- `src/pages/MainContent.tsx`: Added id="main-scroll" for scroll detection, conditional overflow for tab views
- `src/pages/TabContainer.tsx`: Added JavaScript touch/wheel event prevention + `overscroll-behavior: none` for scroll lock
- `src/components/common/SafeAreaBlur.tsx`: Fixed to only respond to #main-scroll container (ignores widget scrolls)

### TypeScript Error Fixes (This Session)
- Reduced TypeScript compilation errors from 295 lines ‚Üí 0 lines
- `NotificationSettings.tsx`: Fixed PushSubscription date type handling (accepts string|number)
- `Dashboard.tsx` + `DevDashboard.tsx`: Fixed LucideIcon vs React.FC type for widget icons
- `Sidebar.tsx`: Fixed TabGroup.id (number) vs Group.id (string), removed invalid framer-motion exit property
- `TabContainer.tsx`: Fixed SystemConfig vs SystemConfigForAuth for auth detection functions
- `ProtectedRoute.tsx`: Fixed groups type mismatch for hasPermission function
- `IntegrationsSettings.tsx`: Fixed duplicate IntegrationConfig type conflicts
- `PlexWidget.tsx`: Fixed PlexSessionData vs PlexSession for modal components

### Known Issue
- **Iframe Tab Container Scroll**: Minor rubber-band scroll behavior on iOS due to Seerr min-height CSS pattern. All functionality works, just visual polish issue.

